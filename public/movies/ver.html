<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproduciendo - AniNova Movies</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/movies-theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body data-page="movies-player">
    <header>
        <div class="container header-content">
            <div class="logo">
                <h1>Ani<span class="highlight">Nova</span> <small style="color: var(--neon-purple);">Movies</small></h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="playerContent" class="container section">
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-left"></i> Volver
        </button>

        <div class="video-container">
            <h3 id="activeTitle" style="text-align: center; margin-bottom: 15px; color: var(--neon-purple);"></h3>
            <div class="video-wrapper">
                <iframe id="videoPlayer" src="" frameborder="0" allowfullscreen allow="autoplay"></iframe>
                <div id="placeholderMessage" class="placeholder-message">
                    <i class="fas fa-film"></i>
                    <h3>Selecciona un idioma</h3>
                    <p>Cargando opciones...</p>
                </div>
            </div>
        </div>

        <div class="server-controls">
            <span><i class="fas fa-language"></i> Audio disponible:</span>
            <div class="server-list" id="audioOptions">
                <button class="server-btn">Cargando...</button>
            </div>
        </div>

        <div class="anime-info-detailed" id="movieInfo">
            <div class="loading">Cargando informaci칩n...</div>
        </div>
    </main>

    <footer>
        <p>춸 2025-2026 AniNova Movies</p>
    </footer>

    <script>
        // NEW: Use Cuevana backend
        const MOVIES_BACKEND_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:4000/api'
            : 'https://TU-RENDER-MOVIES.onrender.com/api'; // Usuario configurar치 esto

        const params = new URLSearchParams(window.location.search);
        const contentId = params.get('id');
        const title = params.get('title');
        const type = params.get('type'); // 'movie' or 'tv'

        // Validate parameters
        if (!contentId || !title) {
            console.error('Missing required parameters');
            document.getElementById('activeTitle').textContent = 'Error: Contenido no encontrado';
            document.getElementById('placeholderMessage').querySelector('p').textContent = 'Por favor, selecciona una pel칤cula o serie desde la p치gina principal.';
            document.getElementById('audioOptions').innerHTML = '<p style="color: #ff4444; padding: 10px;">No se pudo cargar el contenido. <a href="index.html" style="color: var(--neon-purple);">Volver al inicio</a></p>';
        } else {
            document.getElementById('activeTitle').textContent = title;
            loadStreamingOptions();
        }

        async function loadStreamingOptions() {
            const audioOptions = document.getElementById('audioOptions');
            const movieInfo = document.getElementById('movieInfo');

            audioOptions.innerHTML = '<div class="loading">Obteniendo opciones de audio...</div>';

            try {
                const endpoint = `/watch/${type}/${contentId}`;
                const response = await fetch(`${MOVIES_BACKEND_URL}${endpoint}`);
                const data = await response.json();

                if (data.success && data.data) {
                    const { streamingOptions, synopsis, poster } = data.data;

                    // Show movie info
                    if (synopsis || poster) {
                        movieInfo.innerHTML = `
                            ${poster ? `<img src="${poster}" alt="${title}" style="max-width: 200px; border-radius: 10px; margin-bottom: 15px;">` : ''}
                            ${synopsis ? `<p>${synopsis}</p>` : ''}
                        `;
                    }

                    // Show audio options
                    if (streamingOptions && streamingOptions.length > 0) {
                        audioOptions.innerHTML = '';

                        // Add Spanish notice
                        const notice = document.createElement('p');
                        notice.style.cssText = 'font-size: 0.9rem; color: #4ade80; margin: 0 0 15px 0; padding: 10px; background: rgba(74, 222, 128, 0.1); border-radius: 5px;';
                        notice.innerHTML = '<i class="fas fa-check-circle"></i> <strong>Contenido en ESPA칌OL desde Cuevana</strong>';
                        audioOptions.appendChild(notice);

                        streamingOptions.forEach((option, idx) => {
                            const btn = document.createElement('button');
                            btn.className = 'server-btn';

                            // Format audio type
                            let audioLabel = option.audio.toUpperCase();
                            if (option.audio.includes('latino')) audioLabel = '游쓇릖 Latino';
                            else if (option.audio.includes('castellano')) audioLabel = '游쀯릖 Castellano';
                            else if (option.audio.includes('subtitulado')) audioLabel = '游닇 Subtitulado';

                            btn.textContent = audioLabel;
                            btn.onclick = () => loadVideo(audioLabel, option.url);

                            if (idx === 0) {
                                // Auto-select first option
                                setTimeout(() => btn.click(), 1000);
                            }

                            audioOptions.appendChild(btn);
                        });
                    } else {
                        audioOptions.innerHTML = '<p style="color: #ffa500;">No se encontraron opciones de audio. Intenta buscar otro contenido.</p>';
                    }
                } else {
                    audioOptions.innerHTML = '<p style="color: #ff4444;">No se pudo cargar el contenido. <a href="index.html" style="color: var(--neon-purple);">Volver</a></p>';
                }
            } catch (error) {
                console.error('Error loading streaming options:', error);
                audioOptions.innerHTML = '<p style="color: #ff4444;">Error de conexi칩n con el servidor. <a href="index.html" style="color: var(--neon-purple);">Volver</a></p>';
            }
        }

        function loadVideo(audioType, url) {
            const player = document.getElementById('videoPlayer');
            const placeholder = document.getElementById('placeholderMessage');

            placeholder.style.display = 'none';
            player.style.display = 'block';
            player.src = url;

            document.querySelectorAll('.server-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === audioType);
            });

            console.log(`Playing ${audioType}: ${url}`);
        }
    </script>
</body>

</html>