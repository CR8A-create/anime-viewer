<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Anime - AniNova</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body data-page="player">
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <a href="../index.html">
                    <h1>Ani<span class="highlight">Nova</span></h1>
                </a>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="directorio.html">Directorio</a></li>
                    <li><a href="emision.html">En EmisiÃ³n</a></li>
                    <li><a href="../movies/index.html">PelÃ­culas/Series</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="playerContent" class="container section">
        <button class="back-btn" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i> Volver al
            Inicio</button>

        <div class="video-container">
            <h3 id="activeEpisodeTitle" class="active-episode-title"
                style="display:none; text-align: center; margin-bottom: 15px; color: var(--neon-blue); text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);">
            </h3>
            <div class="video-wrapper">
                <iframe id="videoPlayer" src="" frameborder="0" allowfullscreen></iframe>
                <div id="placeholderMessage" class="placeholder-message">
                    <i class="fas fa-film"></i>
                    <h3>Selecciona un Servidor</h3>
                    <p>Buscando enlaces...</p>
                </div>
            </div>
        </div>

        <div class="video-controls">
            <button id="prevEpBtn" class="control-btn" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
            <button id="nextEpBtn" class="control-btn" disabled>Siguiente <i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="server-controls">
            <span><i class="fas fa-server"></i> Servidores:</span>
            <div class="server-list">
                <!-- Buttons injected via JS -->
                <button class="server-btn">Cargando...</button>
            </div>
        </div>

        <div class="anime-info-detailed" id="animeInfoDetailed">
            <!-- Details injected via JS -->
            <div class="loading">Cargando informaciÃ³n del anime...</div>
        </div>

        <!-- Episode List -->
        <div class="episodes-container">
            <h3><i class="fas fa-list-ol"></i> Episodios</h3>
            <div class="episodes-list" id="episodesList">
                <!-- Episodes injected via JS -->
            </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-section" id="commentsSection">
            <h3><i class="fas fa-comments"></i> Comentarios <span class="comment-count" id="commentCount">0</span></h3>
            <div class="comment-input-area">
                <div style="flex: 1;">
                    <textarea id="commentInput" placeholder="Escribe tu comentario anÃ³nimo... (mÃ¡x. 500 caracteres)"
                        maxlength="500"></textarea>
                    <div class="comment-char-count"><span id="charCount">0</span>/500</div>
                    <div class="comment-error" id="commentError" style="display: none;"></div>
                </div>
                <button class="comment-send-btn" id="commentSendBtn" onclick="postAnimeComment()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div id="commentsList">
                <div class="comment-empty">SÃ© el primero en comentar ðŸ’¬</div>
            </div>
        </div>
    </main>

    <footer style="background:#1f1f1f; color:#999; padding:25px; text-align:center; font-size:0.85em;">
        <p><strong>Aviso importante</strong><br>
            Sitio 100% sin fines de lucro Â· Proyecto personal y hobby Â· Uso privado entre amigos<br>
            No alojamos archivos Â· Enlaces de terceros Â· Sin publicidad ni monetizaciÃ³n<br>
            Â© 2025 - 2026 AniNova â€“ Todos los derechos de las obras pertenecen a sus legÃ­timos propietarios.</p>
    </footer>

    <script src="../assets/js/anime-logic.js"></script>
    <script>
        // Anonymous Comments for Anime
        const COMMENTS_API = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:3000/api' : 'https://mi-anime-api.onrender.com/api';

        function getAnimeContentId() {
            const params = new URLSearchParams(window.location.search);
            const anime = params.get('anime') || 'unknown';
            return 'anime_' + anime.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50);
        }

        const animeContentId = getAnimeContentId();

        document.getElementById('commentInput').addEventListener('input', function () {
            document.getElementById('charCount').textContent = this.value.length;
        });

        document.getElementById('commentInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); postAnimeComment(); }
        });

        async function loadAnimeComments() {
            try {
                const response = await fetch(`${COMMENTS_API}/comments/${animeContentId}`);
                const data = await response.json();
                const list = document.getElementById('commentsList');
                const countEl = document.getElementById('commentCount');
                if (data.success && data.comments.length > 0) {
                    countEl.textContent = data.comments.length;
                    list.innerHTML = '';
                    data.comments.reverse().forEach(c => {
                        list.innerHTML += `<div class="comment-item"><div class="comment-header"><span class="comment-author">${escHtml(c.name)}</span><span class="comment-time">${tAgo(c.timestamp)}</span></div><p class="comment-text">${escHtml(c.text)}</p></div>`;
                    });
                } else {
                    countEl.textContent = '0';
                    list.innerHTML = '<div class="comment-empty">SÃ© el primero en comentar ðŸ’¬</div>';
                }
            } catch (err) { console.error('Error loading comments:', err); }
        }

        async function postAnimeComment() {
            const input = document.getElementById('commentInput');
            const btn = document.getElementById('commentSendBtn');
            const errorEl = document.getElementById('commentError');
            const text = input.value.trim();
            if (!text) return;
            btn.disabled = true;
            errorEl.style.display = 'none';
            try {
                const response = await fetch(`${COMMENTS_API}/comments/${animeContentId}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await response.json();
                if (data.success) {
                    input.value = '';
                    document.getElementById('charCount').textContent = '0';
                    loadAnimeComments();
                } else {
                    errorEl.textContent = data.message || 'Error';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'Error de conexiÃ³n';
                errorEl.style.display = 'block';
            }
            setTimeout(() => { btn.disabled = false; }, 2000);
        }

        function escHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function tAgo(ts) {
            const d = Date.now() - new Date(ts).getTime(), m = Math.floor(d / 60000);
            if (m < 1) return 'ahora'; if (m < 60) return `hace ${m}m`;
            const h = Math.floor(m / 60); if (h < 24) return `hace ${h}h`;
            const dd = Math.floor(h / 24); if (dd < 30) return `hace ${dd}d`;
            return new Date(ts).toLocaleDateString('es-ES');
        }

        // Load comments on page load
        loadAnimeComments();
    </script>
</body>

</html>